#include <ESP8266WiFi.h>
#include <MQTTClient.h>
#include <ESP8266WebServer.h>
 
 
const char* ssid     = "LANCOMBEIA";
const char* password = "beialancom";
 
WiFiClient WiFiclient;
MQTTClient client;
 
unsigned long lastMillis = 0;

 /////////////////////////////
 
void setup() {
 Serial.begin(115200);
 delay(10);
 Serial.println();
 Serial.println();
 Serial.print("Connecting to ");
 Serial.println(ssid);

 WiFi.hostname("ESP_OanaSubea");
 WiFi.begin(ssid, password);
 while (WiFi.status() != WL_CONNECTED) {
   delay(500);
   Serial.print(".");
 }
 
 Serial.println("");
 Serial.println("WiFi connected");  
 Serial.println("IP address: ");
 Serial.println(WiFi.localIP());
 delay(2000);
 
 Serial.print("connecting to MQTT broker...");
 client.begin("mqtt.beia-telemetrie.ro", WiFiclient);
 connect();

// Initializare interfata serial

 Serial.begin(115200);

}


/////////////////////////////////////////
// Declaram o variabila "hum" (humidity)

int hum = 0;

// Declaram o variabila "val"

int val = 0;



 /////////////////////////////////////////
 
void connect() {
 while (!client.connect("training/esp_oana", "try", "try")) {
   Serial.print(".");
 }
 
 Serial.println("\nconnected!");
 client.subscribe("training/esp_oana");
 
}


 ////////////////////////////////////////
 
void loop() {

// Senzor Sol:

// Afisam in consola serial mesajul "Moisture Sensor Value:"

  Serial.print("Moisture Sensor Value:");


  // Schimbam scala valorilor citite de senzor, din 0 - 1024 in 0 - 100

  hum = map(analogRead(0), 0, 1024, 0, 100);


  // Afisam valoarea citita de catre senzor in consola serial

  Serial.println(100 - hum);


  // atribuim variabilei "val", rezultatul scaderii

  val = 100 - hum;


  if (val < 20) {

    // Planta are nevoie de apa

    // se va uda timp de 3.5 secunde

  }

  if ((val > 30) && (val < 70) ) {

    // Planta mai vrea putina apa

    // se va uda timp de 1.5 secunde

  }

  if (val > 80) {

    // Planta nu mai are nevoie de apa

  }

  delay(1000);


// Conectare Client MQTT:
  
 client.loop();
 if(!client.connected()) {
   connect();
 }
 
 if(millis() - lastMillis > 1000) {
   lastMillis = millis();
   client.publish("training/esp_oana", (String)val); //Trimite valoarea val 
 }
}

//////////////////////////////////////
